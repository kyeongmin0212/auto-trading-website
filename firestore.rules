rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 사용자 인증 확인 함수
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // 사용자 본인 확인 함수
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // 기존 컬렉션들
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }
    
    match /tradingStrategies/{strategyId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
        resource.data.authorId == request.auth.uid;
    }
    
    match /tradingHistory/{historyId} {
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      allow write: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      allow write: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // 커뮤니티 관련 컬렉션들
    match /posts/{postId} {
      allow read: if true; // 모든 사용자가 게시물을 읽을 수 있음
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && 
        resource.data.authorId == request.auth.uid;
    }
    
    match /comments/{commentId} {
      allow read: if true; // 모든 사용자가 댓글을 읽을 수 있음
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && 
        resource.data.authorId == request.auth.uid;
    }
    
    match /chatMessages/{messageId} {
      allow read: if isAuthenticated(); // 로그인한 사용자만 채팅 메시지를 읽을 수 있음
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && 
        resource.data.authorId == request.auth.uid;
    }
    
    match /postLikes/{likeId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow delete: if isAuthenticated() && 
        likeId.matches(request.auth.uid + '_.*');
    }
    
    // 사용자 온라인 상태
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }
    
    // 기타 보안 규칙
    match /{document=**} {
      allow read, write: if false; // 기본적으로 모든 접근 차단
    }
  }
}